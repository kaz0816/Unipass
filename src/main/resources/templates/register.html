<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>新規登録</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #universitySuggestions {
            z-index: 1000;
            max-height: 220px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-light">

<div class="container py-5" style="max-width: 450px;">
    <h2 class="mb-4 text-center">大学生アカウント登録</h2>

    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <form method="post" action="/register">
        <div class="mb-3">
            <label class="form-label">メールアドレス</label>
            <input type="email" name="email" class="form-control" required>
        </div>

        <div class="mb-3 position-relative">
            <label class="form-label">大学名</label>
            <input type="text" id="universityInput" name="university" class="form-control" placeholder="例：早稲田大学" autocomplete="off" required>
            <div id="universitySuggestions" class="list-group position-absolute w-100 d-none"></div>
        </div>

        <div class="mb-3">
            <label class="form-label">パスワード</label>
            <input type="password" name="password" class="form-control" required>
        </div>

        <button type="submit" class="btn btn-success w-100">登録</button>
    </form>

    <div class="mt-3 text-center">
        <a href="/login">すでにアカウントを持っている方はこちら</a>
    </div>
</div>

<script>
    const universityInput = document.getElementById("universityInput");
    const universitySuggestions = document.getElementById("universitySuggestions");
    let universities = [];

    const fallbackUniversities = [
        "立教大学", "立命館大学", "早稲田大学", "慶應義塾大学", "明治大学", "青山学院大学",
        "中央大学", "法政大学", "同志社大学", "関西大学", "関西学院大学", "近畿大学"
    ];

    const normalize = (text) => (text || "").trim();

    const renderSuggestions = (query) => {
        const q = normalize(query);
        universitySuggestions.innerHTML = "";
        if (!q) {
            universitySuggestions.classList.add("d-none");
            return;
        }
        const matches = universities
            .filter((name) => name.includes(q))
            .slice(0, 10);

        if (matches.length === 0) {
            universitySuggestions.classList.add("d-none");
            return;
        }

        for (const name of matches) {
            const item = document.createElement("button");
            item.type = "button";
            item.className = "list-group-item list-group-item-action";
            item.textContent = name;
            item.addEventListener("click", () => {
                universityInput.value = name;
                universitySuggestions.classList.add("d-none");
            });
            universitySuggestions.appendChild(item);
        }
        universitySuggestions.classList.remove("d-none");
    };

    universityInput.addEventListener("input", (e) => renderSuggestions(e.target.value));
    universityInput.addEventListener("focus", (e) => renderSuggestions(e.target.value));
    universityInput.addEventListener("blur", () => {
        setTimeout(() => universitySuggestions.classList.add("d-none"), 150);
    });

    fetch("/universities.json")
        .then((res) => (res.ok ? res.json() : Promise.reject(new Error("fetch failed"))))
        .then((data) => {
            if (Array.isArray(data)) {
                universities = data;
            } else {
                universities = fallbackUniversities;
            }
        })
        .catch(() => {
            universities = fallbackUniversities;
        });
</script>

</body>
</html>
