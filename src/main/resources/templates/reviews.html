<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>授業レビュー検索</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .suggest-box {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            z-index: 1050;
        }

        .rating-stars {
            position: relative;
            display: inline-block;
            line-height: 1;
        }

        .rating-stars-base {
            color: #d0d0d0;
        }

        .rating-stars-fill {
            position: absolute;
            top: 0;
            left: 0;
            overflow: hidden;
            white-space: nowrap;
            color: #f59f00;
        }
    </style>
</head>
<body class="bg-light">

<div th:replace="fragments/header :: header"></div>

<div class="container py-4">
    <h1 class="mb-4">授業レビュー検索</h1>

    <form action="/reviews" method="get" class="row g-2 align-items-end mb-4">
        <div class="col-md-4 position-relative">
            <label class="form-label mb-1">キーワード</label>
            <input id="keywordInput" type="text" name="keyword" class="form-control"
                   placeholder="授業名・教員名・学校名"
                   autocomplete="off"
                   th:value="${keyword}">
            <div id="universitySuggestBox" class="list-group suggest-box d-none"></div>
        </div>
        <div class="col-md-3">
            <label class="form-label mb-1">対象</label>
            <select id="targetSelect" name="target" class="form-select">
                <option value="all" th:selected="${target} == 'all'">授業名＋教員名＋大学名</option>
                <option value="course" th:selected="${target} == 'course'">授業名のみ</option>
                <option value="teacher" th:selected="${target} == 'teacher'">教員名のみ</option>
                <option value="university" th:selected="${target} == 'university'">学校名のみ</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label mb-1">並び順</label>
            <select name="sort" class="form-select">
                <option value="recent" th:selected="${sort} == 'recent'">新しい順</option>
                <option value="rating" th:selected="${sort} == 'rating'">評価が高い順</option>
                <option value="likes" th:selected="${sort} == 'likes'">いいねが多い順</option>
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-outline-primary w-100">検索</button>
        </div>
    </form>

    <div th:if="${!hasSearched}" class="alert alert-secondary">
        授業名・教員名・学校名を入力して検索すると、レビュー一覧を表示します。
    </div>

    <div th:if="${ratingSummary != null and ratingSummary.totalCount > 0}" class="card mb-4 border-0 shadow-sm">
        <div class="card-body">
            <h2 class="h5 mb-2" th:text="${summaryTitle}">評価サマリー</h2>
            <div class="mb-2">
                <span class="display-6 fw-bold" th:text="${#numbers.formatDecimal(ratingSummary.average, 1, 1)} + ' / 5.0'">4.5 / 5.0</span>
                <span class="text-muted ms-2" th:text="'(' + ${ratingSummary.totalCount} + '件)'">(0件)</span>
            </div>

            <div class="mt-3" th:each="row : ${ratingSummary.breakdowns}">
                <div class="d-flex align-items-center gap-2" th:if="${row.count > 0}">
                    <span style="width:48px" th:text="${#numbers.formatDecimal(row.rating, 1, 1)}">5.0</span>
                    <div class="progress flex-grow-1" style="height: 10px;">
                        <div class="progress-bar bg-warning"
                             th:style="'width:' + ${row.percentage} + '%'"></div>
                    </div>
                    <span class="text-muted small" style="width:48px" th:text="${row.count} + '件'">0件</span>
                </div>
            </div>
        </div>
    </div>

    <div th:if="${hasSearched and #lists.isEmpty(reviews)}" class="alert alert-info">
        条件に一致するレビューがありません。
    </div>

    <div th:if="${hasSearched and !#lists.isEmpty(reviews)}">
        <div class="mb-3 d-flex justify-content-between align-items-center">
            <h2 class="h5 mb-0">検索結果</h2>
            <span class="text-muted" th:text="${#lists.size(reviews)} + '件'">0件</span>
        </div>

        <div class="row row-cols-1 row-cols-md-2 g-3">
            <div class="col" th:each="r : ${reviews}">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">
                            <a th:href="@{'/reviews/' + ${r.id}}"
                               th:text="${r.courseName}">授業名</a>
                        </h5>

                        <h6 class="card-subtitle mb-2 text-muted">
                            教員:
                            <span th:text="${r.teacherName}">先生</span>
                        </h6>

                        <div class="small text-muted mb-2"
                             th:if="${r.user != null and r.user.university != null and !#strings.isEmpty(r.user.university)}">
                            投稿者大学:
                            <a th:href="@{/reviews(target='university', keyword=${r.user.university}, sort='recent')}"
                               th:text="${r.user.university}">大学名</a>
                        </div>

                        <div class="text-muted small mb-2">
                            投稿日:
                            <span th:if="${r.createdAt != null}"
                                  th:text="${#temporals.format(r.createdAt, 'yyyy/MM/dd HH:mm')}"></span>
                            <span th:if="${r.createdAt == null}">-</span>
                        </div>

                        <div class="mb-1 d-flex align-items-center gap-2">
                            <span class="rating-stars" aria-label="rating stars">
                                <span class="rating-stars-base">★★★★★</span>
                                <span class="rating-stars-fill" th:style="'width:' + (${r.rating} * 20) + '%'">★★★★★</span>
                            </span>
                            <span class="text-muted small"
                                  th:text="'(' + ${#numbers.formatDecimal(r.rating, 1, 1)} + '/5.0)'"></span>
                        </div>

                        <div class="mb-2" th:if="${r.imagePath != null}">
                            <img th:src="${r.imagePath}" class="img-fluid rounded">
                        </div>

                        <p class="card-text" th:text="${r.comment}">コメント</p>
                    </div>

                    <div class="card-footer d-flex justify-content-between align-items-center">
                        <form th:action="@{'/reviews/' + ${r.id} + '/like'}"
                              method="post" class="m-0">
                            <button type="submit"
                                    class="btn btn-sm btn-outline-primary">
                                ❤️
                                <span th:text="${r.likes}">0</span>
                            </button>
                        </form>

                        <div class="d-flex gap-2">
                            <a th:href="@{'/reviews/' + ${r.id} + '/edit'}"
                               class="btn btn-sm btn-outline-secondary">
                                編集
                            </a>
                            <form th:action="@{'/reviews/' + ${r.id} + '/delete'}"
                                  method="post" class="m-0">
                                <button type="submit"
                                        class="btn btn-sm btn-outline-danger"
                                        onclick="return confirm('本当に削除しますか？');">
                                    削除
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
<script>
    (() => {
        const keywordInput = document.getElementById("keywordInput");
        const targetSelect = document.getElementById("targetSelect");
        const suggestBox = document.getElementById("universitySuggestBox");
        if (!keywordInput || !targetSelect || !suggestBox) return;

        const placeholderMap = {
            all: "授業名・教員名・学校名",
            course: "授業名",
            teacher: "教員名",
            university: "学校名（例: 明治大学）"
        };

        let debounceTimer = null;
        let requestController = null;
        let activeIndex = -1;

        const updatePlaceholder = () => {
            keywordInput.placeholder = placeholderMap[targetSelect.value] || placeholderMap.all;
        };

        const listItems = () => Array.from(suggestBox.querySelectorAll("button"));

        const hideSuggest = () => {
            suggestBox.classList.add("d-none");
            suggestBox.innerHTML = "";
            activeIndex = -1;
        };

        const activateItem = (index) => {
            const items = listItems();
            items.forEach((item, i) => item.classList.toggle("active", i === index));
            activeIndex = index;
        };

        const selectSuggestion = (value, submitNow) => {
            keywordInput.value = value;
            hideSuggest();
            if (submitNow && keywordInput.form) {
                keywordInput.form.requestSubmit();
            }
        };

        const renderSuggestions = (universities) => {
            if (!universities || universities.length === 0) {
                hideSuggest();
                return;
            }

            suggestBox.innerHTML = "";
            universities.forEach((name, index) => {
                const button = document.createElement("button");
                button.type = "button";
                button.className = "list-group-item list-group-item-action";
                button.textContent = name;
                button.addEventListener("mousedown", (event) => {
                    event.preventDefault();
                    selectSuggestion(name, true);
                });
                button.addEventListener("mousemove", () => activateItem(index));
                suggestBox.appendChild(button);
            });

            suggestBox.classList.remove("d-none");
            activateItem(-1);
        };

        const fetchSuggestions = async (query) => {
            if (requestController) {
                requestController.abort();
            }
            requestController = new AbortController();

            const response = await fetch(`/api/reviews/universities/suggest?q=${encodeURIComponent(query)}`, {
                signal: requestController.signal,
                headers: { "Accept": "application/json" }
            });

            if (!response.ok) return [];
            return response.json();
        };

        const requestSuggest = () => {
            if (targetSelect.value !== "university") {
                hideSuggest();
                return;
            }

            const query = keywordInput.value.trim();
            if (!query) {
                hideSuggest();
                return;
            }

            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(async () => {
                try {
                    const universities = await fetchSuggestions(query);
                    renderSuggestions(universities);
                } catch (error) {
                    if (error.name !== "AbortError") {
                        hideSuggest();
                    }
                }
            }, 140);
        };

        keywordInput.addEventListener("input", requestSuggest);

        keywordInput.addEventListener("keydown", (event) => {
            if (suggestBox.classList.contains("d-none")) return;

            const items = listItems();
            if (items.length === 0) return;

            if (event.key === "ArrowDown") {
                event.preventDefault();
                const next = activeIndex < items.length - 1 ? activeIndex + 1 : 0;
                activateItem(next);
                return;
            }

            if (event.key === "ArrowUp") {
                event.preventDefault();
                const prev = activeIndex > 0 ? activeIndex - 1 : items.length - 1;
                activateItem(prev);
                return;
            }

            if (event.key === "Enter" && activeIndex >= 0) {
                event.preventDefault();
                selectSuggestion(items[activeIndex].textContent || "", true);
                return;
            }

            if (event.key === "Escape") {
                hideSuggest();
            }
        });

        targetSelect.addEventListener("change", () => {
            updatePlaceholder();
            requestSuggest();
        });

        document.addEventListener("click", (event) => {
            if (event.target !== keywordInput && !suggestBox.contains(event.target)) {
                hideSuggest();
            }
        });

        updatePlaceholder();
    })();
</script>
</body>
</html>
