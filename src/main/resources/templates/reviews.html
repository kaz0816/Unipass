<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>授業レビュー検索</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/app.css" rel="stylesheet">
</head>
<body class="app-body">

<div th:replace="fragments/header :: header"></div>

<div class="container py-4">
    <h1 class="page-title mb-4">検索結果</h1>

    <div class="panel-card mb-4 p-3">
        <form action="/reviews/search" method="get" class="row g-2 align-items-end mb-0 search-panel">
            <div class="col-md-4 position-relative">
                <label class="form-label mb-1">キーワード</label>
                <input id="keywordInput" type="text" name="keyword" class="form-control"
                       placeholder="授業名・教員名・学校名"
                       autocomplete="off"
                       th:value="${keyword}">
                <div id="universitySuggestBox" class="list-group suggest-box d-none"></div>
            </div>
            <div class="col-md-3">
                <label class="form-label mb-1">対象</label>
                <select id="targetSelect" name="target" class="form-select">
                    <option value="all" th:selected="${target} == 'all'">授業名＋教員名＋大学名</option>
                    <option value="course" th:selected="${target} == 'course'">授業名のみ</option>
                    <option value="teacher" th:selected="${target} == 'teacher'">教員名のみ</option>
                    <option value="university" th:selected="${target} == 'university'">学校名のみ</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label mb-1">並び順</label>
                <select name="sort" class="form-select">
                    <option value="recent" th:selected="${sort} == 'recent'">新しい順</option>
                    <option value="rating" th:selected="${sort} == 'rating'">評価が高い順</option>
                    <option value="likes" th:selected="${sort} == 'likes'">いいねが多い順</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">検索</button>
            </div>
        </form>
    </div>

    <div th:if="${!hasSearched}" class="alert alert-secondary">
        授業名・教員名・学校名を入力して検索すると、レビュー一覧を表示します。
    </div>

    <div th:if="${ratingSummary != null and ratingSummary.totalCount > 0}" class="panel-card mb-4 p-3">
        <div class="card-body">
            <h2 class="h5 mb-2" th:text="${summaryTitle}">評価サマリー</h2>
            <div class="mb-2">
                <span class="summary-average" th:text="${#numbers.formatDecimal(ratingSummary.average, 1, 1)} + ' / 5.0'">4.5 / 5.0</span>
                <span class="text-muted ms-2" th:text="'(' + ${ratingSummary.totalCount} + '件)'">(0件)</span>
            </div>

            <div class="mt-3 rating-row" th:each="row : ${ratingSummary.breakdowns}">
                <div class="d-flex align-items-center gap-2">
                    <span style="width:48px" th:text="${row.rating} + '★'">5★</span>
                    <div class="progress flex-grow-1">
                        <div class="progress-bar"
                             th:style="'width:' + ${row.percentage} + '%'"></div>
                    </div>
                    <span class="text-muted small" style="width:48px" th:text="${row.count} + '件'">0件</span>
                </div>
            </div>
        </div>
    </div>

    <div th:if="${hasSearched and #lists.isEmpty(reviews)}" class="alert alert-info">
        条件に一致するレビューがありません。
    </div>

    <div th:if="${hasSearched and !#lists.isEmpty(reviews)}">
        <div class="mb-3 d-flex justify-content-between align-items-center">
            <h2 class="h5 mb-0">検索結果</h2>
            <span class="text-muted" th:text="${#lists.size(reviews)} + '件'">0件</span>
        </div>

        <div class="row row-cols-1 row-cols-md-2 g-3">
            <div class="col" th:each="r : ${reviews}">
                <div class="card h-100 review-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <a th:href="@{'/reviews/' + ${r.id}}"
                               th:text="${r.courseName}">授業名</a>
                        </h5>

                        <div class="small mb-1 meta-text"
                             th:with="displayUniversity=${(r.university != null and !#strings.isEmpty(r.university)) ? r.university : (r.user != null ? r.user.university : null)}"
                             th:if="${displayUniversity != null and !#strings.isEmpty(displayUniversity)}">
                            対象大学:
                            <a th:href="@{/reviews/search(target='university', keyword=${displayUniversity}, sort='recent')}"
                               th:text="${displayUniversity}">大学名</a>
                        </div>
                        <div class="small mb-1 meta-text"
                             th:if="${(r.university == null or #strings.isEmpty(r.university)) and (r.user == null or r.user.university == null or #strings.isEmpty(r.user.university))}">
                            対象大学: -
                        </div>

                        <h6 class="card-subtitle mb-2 meta-text">
                            教員:
                            <span th:text="${r.teacherName}">先生</span>
                        </h6>
                        <p class="mb-1 small meta-text">
                            テスト方式:
                            <span th:text="${r.testMethod != null and !#strings.isEmpty(r.testMethod) ? r.testMethod : '-'}">-</span>
                        </p>
                        <p class="mb-2 small meta-text">
                            出席の取り方:
                            <span th:text="${r.attendanceMethod != null and !#strings.isEmpty(r.attendanceMethod) ? r.attendanceMethod : '-'}">-</span>
                        </p>

                        <div class="small meta-text mb-2"
                             th:if="${r.user != null}">
                            投稿者:
                            <span th:text="${(r.user.nickname != null and !#strings.isEmpty(r.user.nickname)) ? r.user.nickname : 'ユーザー'}">ユーザー</span>
                        </div>

                        <div class="meta-text small mb-2">
                            口コミ投稿日:
                            <span th:if="${r.createdAt != null}"
                                  th:text="${#temporals.format(r.createdAt, 'yyyy/MM/dd HH:mm')}"></span>
                            <span th:if="${r.createdAt == null}">-</span>
                        </div>

                        <div class="mb-2 d-flex align-items-center gap-2">
                            <span class="rating-chip" th:text="${#numbers.formatDecimal(r.rating, 1, 1)}">4.5</span>
                            <span class="rating-stars" aria-label="rating stars">
                                <span class="rating-stars-base">★★★★★</span>
                                <span class="rating-stars-fill" th:style="'width:' + (${r.rating} * 20) + '%'">★★★★★</span>
                            </span>
                            <span class="small meta-text">/ 5.0</span>
                        </div>

                        <div class="mb-2" th:if="${r.imagePath != null}">
                            <img th:src="${r.imagePath}" class="img-fluid rounded">
                        </div>

                        <p class="card-text" th:text="${r.comment}">コメント</p>

                        <div class="mt-3" th:with="commentList=${reviewCommentsMap[r.id]}">
                            <div class="small fw-semibold mb-2">コメント一覧</div>

                            <div class="list-group list-group-flush comment-preview p-1"
                                 th:if="${commentList != null and !#lists.isEmpty(commentList)}">
                                <div class="list-group-item px-0 py-2 border-0"
                                     th:each="c : ${commentList}">
                                    <div class="small">
                                        <span class="fw-semibold"
                                              th:text="${(c.user != null and c.user.nickname != null and !#strings.isEmpty(c.user.nickname)) ? c.user.nickname : 'ユーザー'}">ユーザー</span>
                                        :
                                        <span th:text="${c.content}">コメント内容</span>
                                    </div>
                                    <div class="text-muted small">
                                        <span th:if="${c.createdAt != null}"
                                              th:text="${#temporals.format(c.createdAt, 'yyyy/MM/dd HH:mm')}"></span>
                                        <span th:if="${c.createdAt == null}">-</span>
                                    </div>
                                </div>
                            </div>

                            <div class="small text-muted"
                                 th:if="${commentList == null or #lists.isEmpty(commentList)}">
                                まだコメントはありません。
                            </div>

                            <a class="small text-decoration-none"
                               th:href="@{'/reviews/' + ${r.id}}">
                                詳細で全コメントを見る
                            </a>
                        </div>
                    </div>

                    <div class="card-footer d-flex justify-content-between align-items-center">
                        <form th:action="@{'/reviews/' + ${r.id} + '/like'}"
                              method="post" class="m-0">
                            <button type="submit"
                                    class="btn btn-sm btn-outline-primary">
                                ❤️
                                <span th:text="${r.likes}">0</span>
                            </button>
                        </form>

                        <div class="d-flex gap-2"
                             th:if="${r.user != null and currentUserId != null and r.user.id == currentUserId}">
                            <a th:href="@{'/reviews/' + ${r.id} + '/edit'}"
                               class="btn btn-sm btn-outline-secondary">
                                編集
                            </a>
                            <form th:action="@{'/reviews/' + ${r.id} + '/delete'}"
                                  method="post" class="m-0">
                                <button type="submit"
                                        class="btn btn-sm btn-outline-danger"
                                        onclick="return confirm('本当に削除しますか？');">
                                    削除
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
<script>
    (() => {
        const keywordInput = document.getElementById("keywordInput");
        const targetSelect = document.getElementById("targetSelect");
        const suggestBox = document.getElementById("universitySuggestBox");
        if (!keywordInput || !targetSelect || !suggestBox) return;

        const placeholderMap = {
            all: "授業名・教員名・学校名",
            course: "授業名",
            teacher: "教員名",
            university: "学校名（例: 明治大学）"
        };

        let debounceTimer = null;
        let requestController = null;
        let activeIndex = -1;

        const updatePlaceholder = () => {
            keywordInput.placeholder = placeholderMap[targetSelect.value] || placeholderMap.all;
        };

        const listItems = () => Array.from(suggestBox.querySelectorAll("button"));

        const hideSuggest = () => {
            suggestBox.classList.add("d-none");
            suggestBox.innerHTML = "";
            activeIndex = -1;
        };

        const activateItem = (index) => {
            const items = listItems();
            items.forEach((item, i) => item.classList.toggle("active", i === index));
            activeIndex = index;
        };

        const selectSuggestion = (value, submitNow) => {
            keywordInput.value = value;
            hideSuggest();
            if (submitNow && keywordInput.form) {
                keywordInput.form.requestSubmit();
            }
        };

        const renderSuggestions = (universities) => {
            if (!universities || universities.length === 0) {
                hideSuggest();
                return;
            }

            suggestBox.innerHTML = "";
            universities.forEach((name, index) => {
                const button = document.createElement("button");
                button.type = "button";
                button.className = "list-group-item list-group-item-action";
                button.textContent = name;
                button.addEventListener("mousedown", (event) => {
                    event.preventDefault();
                    selectSuggestion(name, true);
                });
                button.addEventListener("mousemove", () => activateItem(index));
                suggestBox.appendChild(button);
            });

            suggestBox.classList.remove("d-none");
            activateItem(-1);
        };

        const fetchSuggestions = async (query) => {
            if (requestController) {
                requestController.abort();
            }
            requestController = new AbortController();

            const response = await fetch(`/api/reviews/universities/suggest?q=${encodeURIComponent(query)}`, {
                signal: requestController.signal,
                headers: { "Accept": "application/json" }
            });

            if (!response.ok) return [];
            return response.json();
        };

        const requestSuggest = () => {
            if (targetSelect.value !== "university") {
                hideSuggest();
                return;
            }

            const query = keywordInput.value.trim();
            if (!query) {
                hideSuggest();
                return;
            }

            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(async () => {
                try {
                    const universities = await fetchSuggestions(query);
                    renderSuggestions(universities);
                } catch (error) {
                    if (error.name !== "AbortError") {
                        hideSuggest();
                    }
                }
            }, 140);
        };

        keywordInput.addEventListener("input", requestSuggest);

        keywordInput.addEventListener("keydown", (event) => {
            if (suggestBox.classList.contains("d-none")) return;

            const items = listItems();
            if (items.length === 0) return;

            if (event.key === "ArrowDown") {
                event.preventDefault();
                const next = activeIndex < items.length - 1 ? activeIndex + 1 : 0;
                activateItem(next);
                return;
            }

            if (event.key === "ArrowUp") {
                event.preventDefault();
                const prev = activeIndex > 0 ? activeIndex - 1 : items.length - 1;
                activateItem(prev);
                return;
            }

            if (event.key === "Enter" && activeIndex >= 0) {
                event.preventDefault();
                selectSuggestion(items[activeIndex].textContent || "", true);
                return;
            }

            if (event.key === "Escape") {
                hideSuggest();
            }
        });

        targetSelect.addEventListener("change", () => {
            updatePlaceholder();
            requestSuggest();
        });

        document.addEventListener("click", (event) => {
            if (event.target !== keywordInput && !suggestBox.contains(event.target)) {
                hideSuggest();
            }
        });

        updatePlaceholder();
    })();
</script>
</body>
</html>
